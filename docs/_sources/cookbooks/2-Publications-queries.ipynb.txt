{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "# Publication queries \n",
    "\n",
    "This notebook contains a collection of common publication queries for [Dimensions on Google BigQuery](https://docs.dimensions.ai/bigquery/).\n",
    "\n",
    "For more background, see also the [publications data model](https://docs.dimensions.ai/bigquery/datasource-publications.html). \n",
    "\n",
    "## Prerequisites\n",
    "\n",
    "This tutorial assumed that you have a Dimensions on Google BigQuery account and have completed the [Verifying your connection](https://digital-science.github.io/dimensions-gbq-lab/cookbooks/1-Verifying-your-connection.html) notebook. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The google.cloud.bigquery extension is already loaded. To reload it, use:\n",
      "  %reload_ext google.cloud.bigquery\n",
      "==\n",
      "Authenticating..\n",
      "..done (method: local credentials)\n"
     ]
    }
   ],
   "source": [
    "!pip install google-cloud-bigquery -U --quiet\n",
    "%load_ext google.cloud.bigquery\n",
    "\n",
    "import sys\n",
    "print(\"==\\nAuthenticating..\")\n",
    "if 'google.colab' in sys.modules:\n",
    "    from google.colab import auth\n",
    "    auth.authenticate_user()\n",
    "    print('..done (method: Colab)')\n",
    "else:\n",
    "    from google.cloud import bigquery\n",
    "    print('..done (method: local credentials)')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "Update the value of `MY_PROJECT_ID` as needed and run the cell below to get started. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "==\n",
      "Testing connection..\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Total_Publications</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>115963650</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   Total_Publications\n",
       "0           115963650"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "MY_PROJECT_ID = \"ds-data-solutions-gbq\"\n",
    "\n",
    "print(\"==\\nTesting connection..\")\n",
    "client = bigquery.Client(project=MY_PROJECT_ID)\n",
    "client.query(\"\"\"\n",
    "    SELECT COUNT(*) as Total_Publications \n",
    "    from `dimensions-ai.data_analytics.publications`\n",
    "    \"\"\").to_dataframe()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## 1. Top publications by Altmetric score and research organization \n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.07s: 100%|██████████| 2/2 [00:00<00:00, 908.64query/s]                         \n",
      "Downloading: 100%|██████████| 5/5 [00:02<00:00,  1.99rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>title</th>\n",
       "      <th>authors</th>\n",
       "      <th>altmetrics_score</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>pub.1130340155</td>\n",
       "      <td>Two metres or one: what is the evidence for ph...</td>\n",
       "      <td>6</td>\n",
       "      <td>15626</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>pub.1129493369</td>\n",
       "      <td>Safety and immunogenicity of the ChAdOx1 nCoV-...</td>\n",
       "      <td>366</td>\n",
       "      <td>15382</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>pub.1127239818</td>\n",
       "      <td>Remdesivir in adults with severe COVID-19: a r...</td>\n",
       "      <td>46</td>\n",
       "      <td>12139</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>pub.1133359801</td>\n",
       "      <td>Safety and efficacy of the ChAdOx1 nCoV-19 vac...</td>\n",
       "      <td>766</td>\n",
       "      <td>11111</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>pub.1131721397</td>\n",
       "      <td>Scientific consensus on the COVID-19 pandemic:...</td>\n",
       "      <td>31</td>\n",
       "      <td>10429</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "               id                                              title  authors  \\\n",
       "0  pub.1130340155  Two metres or one: what is the evidence for ph...        6   \n",
       "1  pub.1129493369  Safety and immunogenicity of the ChAdOx1 nCoV-...      366   \n",
       "2  pub.1127239818  Remdesivir in adults with severe COVID-19: a r...       46   \n",
       "3  pub.1133359801  Safety and efficacy of the ChAdOx1 nCoV-19 vac...      766   \n",
       "4  pub.1131721397  Scientific consensus on the COVID-19 pandemic:...       31   \n",
       "\n",
       "   altmetrics_score  \n",
       "0             15626  \n",
       "1             15382  \n",
       "2             12139  \n",
       "3             11111  \n",
       "4             10429  "
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "-- Top 5 pubs by Altmetric Score for GRID ID grid.4991.5 in the year 2020\n",
    "\n",
    "SELECT\n",
    "  id,\n",
    "  title.preferred as title,\n",
    "  ARRAY_LENGTH(authors) as authors,\n",
    "  altmetrics.score as altmetrics_score\n",
    "FROM\n",
    "  `dimensions-ai.data_analytics.publications`\n",
    "WHERE\n",
    "  year = 2020 AND 'grid.4991.5' in UNNEST(research_orgs)\n",
    "ORDER BY\n",
    "  altmetrics.score desc\n",
    "LIMIT 5"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## 2. Working with Publications dates \n",
    "\n",
    "Each publication has various dates available. \n",
    "\n",
    "* date, year, date_normal, date_online, date_print refer to the publication object. See the [documentation](https://docs.dimensions.ai/bigquery/datasource-publications.html) to find out more about their meaning. \n",
    "* date_imported_gbq refers to when this record was last added to GBQ - this date can be handy if you want to synchronize an external data source to GBQ. \n",
    "* date_inserted: this refers to when this records was originally added to Dimensions (if the records gets adjusted later, it doesn't change). "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 2/2 [00:00<00:00, 905.80query/s]                         \n",
      "Downloading: 100%|██████████| 10/10 [00:02<00:00,  4.10rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>doi</th>\n",
       "      <th>date</th>\n",
       "      <th>date_normal</th>\n",
       "      <th>year</th>\n",
       "      <th>date_online</th>\n",
       "      <th>date_print</th>\n",
       "      <th>date_imported_gbq</th>\n",
       "      <th>date_inserted</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>10.1038/nbt.1621</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010-05</td>\n",
       "      <td>2021-02-10 01:09:29+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>10.1038/nbt.1630</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010-05</td>\n",
       "      <td>2021-02-10 01:09:29+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>10.1038/nbt.1614</td>\n",
       "      <td>2010-03</td>\n",
       "      <td>2010-03-01</td>\n",
       "      <td>2010</td>\n",
       "      <td>None</td>\n",
       "      <td>2010-03</td>\n",
       "      <td>2021-02-10 01:09:29+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>10.1038/nbt.1685</td>\n",
       "      <td>2010-10-13</td>\n",
       "      <td>2010-10-13</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-10-13</td>\n",
       "      <td>2010-10</td>\n",
       "      <td>2021-02-10 00:53:56+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>10.1038/nbt1210-1248</td>\n",
       "      <td>2010-12-07</td>\n",
       "      <td>2010-12-07</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-12-07</td>\n",
       "      <td>2010-12</td>\n",
       "      <td>2021-02-10 00:53:56+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>10.1038/nbt.1755</td>\n",
       "      <td>2010-12-22</td>\n",
       "      <td>2010-12-22</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-12-22</td>\n",
       "      <td>2011-02</td>\n",
       "      <td>2021-02-10 01:09:29+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>10.1038/nbt1010-1045</td>\n",
       "      <td>2010-10-13</td>\n",
       "      <td>2010-10-13</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-10-13</td>\n",
       "      <td>2010-10</td>\n",
       "      <td>2021-02-10 00:53:56+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>10.1038/nbt.1633</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-05-02</td>\n",
       "      <td>2010-05</td>\n",
       "      <td>2021-02-10 00:53:56+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>10.1038/nbt.1667</td>\n",
       "      <td>2010-07-19</td>\n",
       "      <td>2010-07-19</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-07-19</td>\n",
       "      <td>2010-08</td>\n",
       "      <td>2021-02-10 01:09:29+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>10.1038/nbt.1641</td>\n",
       "      <td>2010-05-23</td>\n",
       "      <td>2010-05-23</td>\n",
       "      <td>2010</td>\n",
       "      <td>2010-05-23</td>\n",
       "      <td>2010-06</td>\n",
       "      <td>2021-02-10 00:53:56+00:00</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                    doi        date date_normal  year date_online date_print  \\\n",
       "0      10.1038/nbt.1621  2010-05-02  2010-05-02  2010  2010-05-02    2010-05   \n",
       "1      10.1038/nbt.1630  2010-05-02  2010-05-02  2010  2010-05-02    2010-05   \n",
       "2      10.1038/nbt.1614     2010-03  2010-03-01  2010        None    2010-03   \n",
       "3      10.1038/nbt.1685  2010-10-13  2010-10-13  2010  2010-10-13    2010-10   \n",
       "4  10.1038/nbt1210-1248  2010-12-07  2010-12-07  2010  2010-12-07    2010-12   \n",
       "5      10.1038/nbt.1755  2010-12-22  2010-12-22  2010  2010-12-22    2011-02   \n",
       "6  10.1038/nbt1010-1045  2010-10-13  2010-10-13  2010  2010-10-13    2010-10   \n",
       "7      10.1038/nbt.1633  2010-05-02  2010-05-02  2010  2010-05-02    2010-05   \n",
       "8      10.1038/nbt.1667  2010-07-19  2010-07-19  2010  2010-07-19    2010-08   \n",
       "9      10.1038/nbt.1641  2010-05-23  2010-05-23  2010  2010-05-23    2010-06   \n",
       "\n",
       "          date_imported_gbq             date_inserted  \n",
       "0 2021-02-10 01:09:29+00:00 2017-08-31 12:50:56+00:00  \n",
       "1 2021-02-10 01:09:29+00:00 2017-08-31 12:50:56+00:00  \n",
       "2 2021-02-10 01:09:29+00:00 2017-08-31 12:50:56+00:00  \n",
       "3 2021-02-10 00:53:56+00:00 2017-08-31 12:50:56+00:00  \n",
       "4 2021-02-10 00:53:56+00:00 2017-08-31 12:50:56+00:00  \n",
       "5 2021-02-10 01:09:29+00:00 2017-08-31 12:50:56+00:00  \n",
       "6 2021-02-10 00:53:56+00:00 2017-08-31 12:50:56+00:00  \n",
       "7 2021-02-10 00:53:56+00:00 2017-08-31 12:50:56+00:00  \n",
       "8 2021-02-10 01:09:29+00:00 2017-08-31 12:50:56+00:00  \n",
       "9 2021-02-10 00:53:56+00:00 2017-08-31 12:50:56+00:00  "
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select doi, date, date_normal, year, date_online, date_print, date_imported_gbq, date_inserted \n",
    "from `dimensions-ai.data_analytics.publications`\n",
    "where year = 2010 and journal.id = \"jour.1115214\"\n",
    "order by citations_count desc \n",
    "limit 10"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "### Number of publications added to Dimensions by month"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 3/3 [00:00<00:00, 2546.63query/s]                        \n",
      "Downloading: 100%|██████████| 5/5 [00:02<00:00,  1.99rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>countDim</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2021-02-01</td>\n",
       "      <td>174570</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2021-01-01</td>\n",
       "      <td>685667</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2020-12-01</td>\n",
       "      <td>820007</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2020-11-01</td>\n",
       "      <td>573519</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2020-10-01</td>\n",
       "      <td>718132</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        date  countDim\n",
       "0 2021-02-01    174570\n",
       "1 2021-01-01    685667\n",
       "2 2020-12-01    820007\n",
       "3 2020-11-01    573519\n",
       "4 2020-10-01    718132"
      ]
     },
     "execution_count": 13,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "SELECT \n",
    "  DATETIME_TRUNC(DATETIME(date_inserted), MONTH) as date,\n",
    "  COUNT(id) as countDim\n",
    "FROM\n",
    "  `dimensions-ai.data_analytics.publications`\n",
    "GROUP BY date  \n",
    "ORDER BY date DESC\n",
    "LIMIT 5\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Top N publications by citations percentile"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 3/3 [00:00<00:00, 2074.33query/s]                        \n",
      "Downloading: 100%|██████████| 7034/7034 [00:02<00:00, 2580.02rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>title</th>\n",
       "      <th>citations</th>\n",
       "      <th>citation_percentile</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>pub.1129408972</td>\n",
       "      <td>Estimation of total flavonoid content in propo...</td>\n",
       "      <td>881</td>\n",
       "      <td>0.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>pub.1122861707</td>\n",
       "      <td>Mercury 4.0: from visualization to analysis, d...</td>\n",
       "      <td>393</td>\n",
       "      <td>0.000001</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>pub.1125814051</td>\n",
       "      <td>Analysis and forecast of COVID-19 spreading in...</td>\n",
       "      <td>286</td>\n",
       "      <td>0.000003</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>pub.1126110231</td>\n",
       "      <td>Covid-19: automatic detection from X-ray image...</td>\n",
       "      <td>255</td>\n",
       "      <td>0.000004</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>pub.1125821215</td>\n",
       "      <td>The Role of Telehealth in Reducing the Mental ...</td>\n",
       "      <td>234</td>\n",
       "      <td>0.000006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7029</th>\n",
       "      <td>pub.1126789618</td>\n",
       "      <td>First Successful Treatment of Coronavirus Dise...</td>\n",
       "      <td>14</td>\n",
       "      <td>0.008954</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7030</th>\n",
       "      <td>pub.1126819649</td>\n",
       "      <td>Advanced Matrixes for Binder‐Free Nanostructur...</td>\n",
       "      <td>14</td>\n",
       "      <td>0.008954</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7031</th>\n",
       "      <td>pub.1128192899</td>\n",
       "      <td>A hybrid multi-scale model of COVID-19 transmi...</td>\n",
       "      <td>14</td>\n",
       "      <td>0.008954</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7032</th>\n",
       "      <td>pub.1128190805</td>\n",
       "      <td>Z-scheme In2O3/WO3 heterogeneous photocatalyst...</td>\n",
       "      <td>14</td>\n",
       "      <td>0.008954</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7033</th>\n",
       "      <td>pub.1128158289</td>\n",
       "      <td>Properties of fresh and hardened fly ash/slag ...</td>\n",
       "      <td>14</td>\n",
       "      <td>0.008954</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>7034 rows × 4 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                  id                                              title  \\\n",
       "0     pub.1129408972  Estimation of total flavonoid content in propo...   \n",
       "1     pub.1122861707  Mercury 4.0: from visualization to analysis, d...   \n",
       "2     pub.1125814051  Analysis and forecast of COVID-19 spreading in...   \n",
       "3     pub.1126110231  Covid-19: automatic detection from X-ray image...   \n",
       "4     pub.1125821215  The Role of Telehealth in Reducing the Mental ...   \n",
       "...              ...                                                ...   \n",
       "7029  pub.1126789618  First Successful Treatment of Coronavirus Dise...   \n",
       "7030  pub.1126819649  Advanced Matrixes for Binder‐Free Nanostructur...   \n",
       "7031  pub.1128192899  A hybrid multi-scale model of COVID-19 transmi...   \n",
       "7032  pub.1128190805  Z-scheme In2O3/WO3 heterogeneous photocatalyst...   \n",
       "7033  pub.1128158289  Properties of fresh and hardened fly ash/slag ...   \n",
       "\n",
       "      citations  citation_percentile  \n",
       "0           881             0.000000  \n",
       "1           393             0.000001  \n",
       "2           286             0.000003  \n",
       "3           255             0.000004  \n",
       "4           234             0.000006  \n",
       "...         ...                  ...  \n",
       "7029         14             0.008954  \n",
       "7030         14             0.008954  \n",
       "7031         14             0.008954  \n",
       "7032         14             0.008954  \n",
       "7033         14             0.008954  \n",
       "\n",
       "[7034 rows x 4 columns]"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "WITH pubs AS (\n",
    "  SELECT\n",
    "    p.id as id, \n",
    "    p.title.preferred as title,\n",
    "    p.citations_count as citations,\n",
    "  FROM\n",
    "    `dimensions-ai.data_analytics.publications` p\n",
    "  WHERE year = 2020 AND \"09\" IN UNNEST(category_for.first_level.codes)\n",
    "),\n",
    "ranked_pubs AS (\n",
    "  SELECT\n",
    "    p.*,\n",
    "    PERCENT_RANK() OVER (ORDER BY p.citations DESC) citation_percentile\n",
    "  FROM\n",
    "    pubs p\n",
    ")\n",
    "SELECT * FROM ranked_pubs\n",
    "WHERE citation_percentile <= 0.01\n",
    "ORDER BY citation_percentile asc"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Citations by journal, for a specific publisher "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 5/5 [00:00<00:00, 3541.29query/s]                        \n",
      "Downloading: 100%|██████████| 10/10 [00:02<00:00,  4.11rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "      <th>journal</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>26147</td>\n",
       "      <td>Scientific Reports</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>18794</td>\n",
       "      <td>International Journal of Molecular Sciences</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>8647</td>\n",
       "      <td>Frontiers in Microbiology</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>8620</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>7695</td>\n",
       "      <td>Frontiers in Immunology</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>6960</td>\n",
       "      <td>International Journal of Environmental Researc...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>6421</td>\n",
       "      <td>Nature Communications</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>6145</td>\n",
       "      <td>Cells</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>5687</td>\n",
       "      <td>Cancers</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>5006</td>\n",
       "      <td>Microorganisms</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "     tot                                            journal\n",
       "0  26147                                 Scientific Reports\n",
       "1  18794        International Journal of Molecular Sciences\n",
       "2   8647                          Frontiers in Microbiology\n",
       "3   8620                                               None\n",
       "4   7695                            Frontiers in Immunology\n",
       "5   6960  International Journal of Environmental Researc...\n",
       "6   6421                              Nature Communications\n",
       "7   6145                                              Cells\n",
       "8   5687                                            Cancers\n",
       "9   5006                                     Microorganisms"
      ]
     },
     "execution_count": 20,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "WITH publisher_pubs AS (\n",
    "  SELECT id FROM `dimensions-ai.data_analytics.publications`\n",
    "  WHERE publisher.id = \"pblshr.1000340\" AND type = \"article\"\n",
    ")\n",
    "\n",
    "SELECT \n",
    "  COUNT(p.id) as tot,\n",
    "  p.journal.title as journal\n",
    "FROM `dimensions-ai.data_analytics.publications` p, UNNEST(p.reference_ids) r\n",
    "WHERE \n",
    "  p.year = 2020 AND p.type = \"article\"      -- restrict to articles with a published year of 2020\n",
    "  AND p.publisher.id <> \"pblshr.1000340\"    -- where the publisher is not the same as the pusblisher above\n",
    "  AND r IN (SELECT * FROM publisher_pubs)   -- the publication must reference a publishers publication\n",
    "GROUP BY journal\n",
    "ORDER BY tot DESC\n",
    "LIMIT 10"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Researchers related to a selected GRID and category [REVIEW]\n",
    "\n",
    "* Using publications to identify researchers of interest\n",
    "* Using researchers db to get more infos about them "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "WITH researchers AS \n",
    "(\n",
    "  SELECT DISTINCT res_id\n",
    "  from `dimensions-ai.data_analytics.publications`, UNNEST(researcher_ids) res_id \n",
    "  where \"grid.4991.5\" in UNNEST(research_orgs)\n",
    "  AND \"2204\" in UNNEST(category_for.second_level.codes)\n",
    "  AND year = 2020\n",
    ")\n",
    "\n",
    "\n",
    "SELECT id, current_research_org, last_publication_year, total_grants\n",
    "from `dimensions-ai.data_analytics.researchers`r1\n",
    "join researchers r2 \n",
    "on r1.id = r2.res_id\n",
    "order by total_publications desc\n",
    "limit 10"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Generate list of authors for a publication by flattening/concatenating\n",
    "\n",
    "IE Flattening an array of objects into a string"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.01s: 100%|██████████| 1/1 [00:00<00:00, 86.44query/s]                           \n",
      "Downloading: 100%|██████████| 1/1 [00:02<00:00,  2.49s/rows]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>authors_list</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>pub.1132070778</td>\n",
       "      <td>O Grånäs; A Mocellin; E S Cardoso; F Burmeiste...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "               id                                       authors_list\n",
       "0  pub.1132070778  O Grånäs; A Mocellin; E S Cardoso; F Burmeiste..."
      ]
     },
     "execution_count": 30,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select\n",
    "  p.id,\n",
    "  ARRAY_TO_STRING((\n",
    "    SELECT ARRAY(SELECT CONCAT(first_name, \" \", last_name) FROM UNNEST(p.authors))\n",
    "   ), '; ') as authors_list\n",
    "from `dimensions-ai.data_analytics.publications` p\n",
    "where p.id = 'pub.1132070778'"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Generate list of categories for a publication by flattening/concatenating\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 1/1 [00:00<00:00, 721.54query/s]                          \n",
      "Downloading: 100%|██████████| 1/1 [00:04<00:00,  4.17s/rows]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>categories_list</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>pub.1132070778</td>\n",
       "      <td>Physical Sciences; Chemical Sciences</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "               id                       categories_list\n",
       "0  pub.1132070778  Physical Sciences; Chemical Sciences"
      ]
     },
     "execution_count": 33,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select\n",
    "  p.id, \n",
    "  ARRAY_TO_STRING((\n",
    "    SELECT ARRAY(SELECT name FROM UNNEST(p.category_for.first_level.full))\n",
    "   ), '; ') as categories_list\n",
    "from `dimensions-ai.data_analytics.publications` p\n",
    "where p.id = 'pub.1132070778'"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## One-degree citation network for a single publication"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 4/4 [00:00<00:00, 1477.65query/s]                        \n",
      "Downloading: 100%|██████████| 187/187 [00:02<00:00, 80.92rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>citation_from</th>\n",
       "      <th>citation_to</th>\n",
       "      <th>level</th>\n",
       "      <th>citation_year</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>pub.1114028205</td>\n",
       "      <td>pub.1131160226</td>\n",
       "      <td>2</td>\n",
       "      <td>2020</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>pub.1106819031</td>\n",
       "      <td>pub.1116024231</td>\n",
       "      <td>2</td>\n",
       "      <td>2019</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>pub.1106819031</td>\n",
       "      <td>pub.1110011840</td>\n",
       "      <td>2</td>\n",
       "      <td>2018</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>pub.1106819031</td>\n",
       "      <td>pub.1106383928</td>\n",
       "      <td>2</td>\n",
       "      <td>2018</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>pub.1106819031</td>\n",
       "      <td>pub.1127419935</td>\n",
       "      <td>2</td>\n",
       "      <td>2020</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>182</th>\n",
       "      <td>pub.1043374025</td>\n",
       "      <td>pub.1028868656</td>\n",
       "      <td>2</td>\n",
       "      <td>2006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>183</th>\n",
       "      <td>pub.1043374025</td>\n",
       "      <td>pub.1084164363</td>\n",
       "      <td>2</td>\n",
       "      <td>2017</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>184</th>\n",
       "      <td>pub.1053387944</td>\n",
       "      <td>pub.1104020017</td>\n",
       "      <td>2</td>\n",
       "      <td>2018</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>185</th>\n",
       "      <td>pub.1053387944</td>\n",
       "      <td>pub.1013860913</td>\n",
       "      <td>2</td>\n",
       "      <td>2007</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>186</th>\n",
       "      <td>pub.1053387944</td>\n",
       "      <td>pub.1049073580</td>\n",
       "      <td>2</td>\n",
       "      <td>2016</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>187 rows × 4 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      citation_from     citation_to  level  citation_year\n",
       "0    pub.1114028205  pub.1131160226      2           2020\n",
       "1    pub.1106819031  pub.1116024231      2           2019\n",
       "2    pub.1106819031  pub.1110011840      2           2018\n",
       "3    pub.1106819031  pub.1106383928      2           2018\n",
       "4    pub.1106819031  pub.1127419935      2           2020\n",
       "..              ...             ...    ...            ...\n",
       "182  pub.1043374025  pub.1028868656      2           2006\n",
       "183  pub.1043374025  pub.1084164363      2           2017\n",
       "184  pub.1053387944  pub.1104020017      2           2018\n",
       "185  pub.1053387944  pub.1013860913      2           2007\n",
       "186  pub.1053387944  pub.1049073580      2           2016\n",
       "\n",
       "[187 rows x 4 columns]"
      ]
     },
     "execution_count": 35,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "WITH level1 AS (\n",
    "  select \"pub.1099396382\" as citation_from, citations.id as citation_to, 1 as level, citations.year as citation_year\n",
    "  from `dimensions-ai.data_analytics.publications` p, unnest(citations) as citations\n",
    "  where p.id=\"pub.1099396382\"\n",
    "),\n",
    "\n",
    "level2 AS (\n",
    "  select l.citation_to as citation_from, citations.id as citation_to, 2 as level, citations.year as citation_year\n",
    "  from `dimensions-ai.data_analytics.publications` p, unnest(citations) as citations, level1 l\n",
    "  where p.id = l.citation_to\n",
    ")\n",
    "\n",
    "SELECT * from level1 \n",
    "UNION ALL\n",
    "SELECT * from level2 "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Publications per category, total and percentage against total"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 5/5 [00:00<00:00, 2172.99query/s]                        \n",
      "Downloading: 100%|██████████| 22/22 [00:02<00:00,  8.67rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>name</th>\n",
       "      <th>pubs_global</th>\n",
       "      <th>pubs_global_pc</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Biological Sciences</td>\n",
       "      <td>8922205</td>\n",
       "      <td>7.69</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Medical and Health Sciences</td>\n",
       "      <td>29853801</td>\n",
       "      <td>25.74</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Economics</td>\n",
       "      <td>1722795</td>\n",
       "      <td>1.49</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Engineering</td>\n",
       "      <td>12168683</td>\n",
       "      <td>10.49</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Education</td>\n",
       "      <td>1804004</td>\n",
       "      <td>1.56</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>Information and Computing Sciences</td>\n",
       "      <td>5118832</td>\n",
       "      <td>4.41</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>History and Archaeology</td>\n",
       "      <td>2333998</td>\n",
       "      <td>2.01</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>Technology</td>\n",
       "      <td>1932511</td>\n",
       "      <td>1.67</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>Commerce, Management, Tourism and Services</td>\n",
       "      <td>1792537</td>\n",
       "      <td>1.55</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>Studies in Creative Arts and Writing</td>\n",
       "      <td>639952</td>\n",
       "      <td>0.55</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>Physical Sciences</td>\n",
       "      <td>6092552</td>\n",
       "      <td>5.25</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>Mathematical Sciences</td>\n",
       "      <td>4979926</td>\n",
       "      <td>4.29</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>Environmental Sciences</td>\n",
       "      <td>1349369</td>\n",
       "      <td>1.16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>Psychology and Cognitive Sciences</td>\n",
       "      <td>3822870</td>\n",
       "      <td>3.30</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>Chemical Sciences</td>\n",
       "      <td>7766182</td>\n",
       "      <td>6.70</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>Law and Legal Studies</td>\n",
       "      <td>883855</td>\n",
       "      <td>0.76</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>Earth Sciences</td>\n",
       "      <td>2027739</td>\n",
       "      <td>1.75</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>Agricultural and Veterinary Sciences</td>\n",
       "      <td>2085752</td>\n",
       "      <td>1.80</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>Philosophy and Religious Studies</td>\n",
       "      <td>1662674</td>\n",
       "      <td>1.43</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>Built Environment and Design</td>\n",
       "      <td>480440</td>\n",
       "      <td>0.41</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>Language, Communication and Culture</td>\n",
       "      <td>2494744</td>\n",
       "      <td>2.15</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>Studies in Human Society</td>\n",
       "      <td>3362309</td>\n",
       "      <td>2.90</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                                          name  pubs_global  pubs_global_pc\n",
       "0                          Biological Sciences      8922205            7.69\n",
       "1                  Medical and Health Sciences     29853801           25.74\n",
       "2                                    Economics      1722795            1.49\n",
       "3                                  Engineering     12168683           10.49\n",
       "4                                    Education      1804004            1.56\n",
       "5           Information and Computing Sciences      5118832            4.41\n",
       "6                      History and Archaeology      2333998            2.01\n",
       "7                                   Technology      1932511            1.67\n",
       "8   Commerce, Management, Tourism and Services      1792537            1.55\n",
       "9         Studies in Creative Arts and Writing       639952            0.55\n",
       "10                           Physical Sciences      6092552            5.25\n",
       "11                       Mathematical Sciences      4979926            4.29\n",
       "12                      Environmental Sciences      1349369            1.16\n",
       "13           Psychology and Cognitive Sciences      3822870            3.30\n",
       "14                           Chemical Sciences      7766182            6.70\n",
       "15                       Law and Legal Studies       883855            0.76\n",
       "16                              Earth Sciences      2027739            1.75\n",
       "17        Agricultural and Veterinary Sciences      2085752            1.80\n",
       "18            Philosophy and Religious Studies      1662674            1.43\n",
       "19                Built Environment and Design       480440            0.41\n",
       "20         Language, Communication and Culture      2494744            2.15\n",
       "21                    Studies in Human Society      3362309            2.90"
      ]
     },
     "execution_count": 36,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "SELECT\n",
    "  cat.name,\n",
    "  COUNT(DISTINCT p.id) AS pubs_global,\n",
    "  ROUND ((COUNT(DISTINCT p.id) * 100 /(\n",
    "      SELECT\n",
    "        COUNT(*)\n",
    "      FROM\n",
    "        `dimensions-ai.data_analytics.publications`)), 2 ) AS pubs_global_pc\n",
    "FROM\n",
    "  `dimensions-ai.data_analytics.publications` p,\n",
    "  UNNEST(category_for.first_level.full) cat\n",
    "GROUP BY\n",
    "  cat.name"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Heads up - about UNNEST \n",
    "\n",
    "UNNEST are implicit 'cross-join' queries, hence only records that have some value in the nested column are represented\n",
    "\n",
    "For example, the query below return less publications that then ones available, because only the ones with `research_org_country_names` are included (= cross join)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 45,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 3/3 [00:00<00:00, 2579.52query/s]                        \n",
      "Downloading: 100%|██████████| 1/1 [00:04<00:00,  4.60s/rows]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot_articles</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1060342</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   tot_articles\n",
       "0       1060342"
      ]
     },
     "execution_count": 45,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "SELECT count(distinct p.id) as tot_articles\n",
    "FROM `dimensions-ai.data_analytics.publications` p \n",
    "    , UNNEST(research_org_country_names) as research_org_country_names\n",
    "WHERE year = 2000"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "As a test, we can run the query without the UNNEST clause"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 3/3 [00:00<00:00, 2101.00query/s]                        \n",
      "Downloading: 100%|██████████| 1/1 [00:02<00:00,  2.97s/rows]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot_articles</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1759389</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   tot_articles\n",
       "0       1759389"
      ]
     },
     "execution_count": 44,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "SELECT count(distinct p.id) as tot_articles\n",
    "FROM `dimensions-ai.data_analytics.publications` p \n",
    "WHERE year = 2000\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "If you want to get all records, then LEFT JOIN is the way to go in this case"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 47,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 3/3 [00:00<00:00, 1973.48query/s]                        \n",
      "Downloading: 100%|██████████| 1/1 [00:03<00:00,  3.90s/rows]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot_articles</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1759389</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   tot_articles\n",
       "0       1759389"
      ]
     },
     "execution_count": 47,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "\n",
    "SELECT count(distinct p.id) as tot_articles\n",
    "FROM `dimensions-ai.data_analytics.publications` p \n",
    "LEFT JOIN UNNEST(research_org_country_names) as research_org_country_names\n",
    "WHERE year = 2000"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Find articles mathcing a specific affiliation string"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 48,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 2/2 [00:00<00:00, 1575.33query/s]                        \n",
      "Downloading: 100%|██████████| 5920/5920 [00:02<00:00, 2237.13rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>grid_id</th>\n",
       "      <th>raw_affiliation</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>pub.1121839087</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Evidence-based Cardiovascular Medicine, Tohoku...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>pub.1121839087</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Evidence-based Cardiovascular Medicine, Tohoku...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>pub.1121837499</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Molecular Endocrinology, Tohoku ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>pub.1121837499</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Molecular Endocrinology, Tohoku ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>pub.1121837499</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Molecular Endocrinology, Tohoku ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5915</th>\n",
       "      <td>pub.1131102254</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Neurosurgery, Tohoku University ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5916</th>\n",
       "      <td>pub.1131102254</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Neurosurgery, Tohoku University ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5917</th>\n",
       "      <td>pub.1131102254</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Neurosurgical Engineering and Tr...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5918</th>\n",
       "      <td>pub.1131102254</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Neurosurgery, Tohoku University ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5919</th>\n",
       "      <td>pub.1131102254</td>\n",
       "      <td>grid.69566.3a</td>\n",
       "      <td>Department of Neurosurgery, Tohoku University ...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5920 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                  id        grid_id  \\\n",
       "0     pub.1121839087  grid.69566.3a   \n",
       "1     pub.1121839087  grid.69566.3a   \n",
       "2     pub.1121837499  grid.69566.3a   \n",
       "3     pub.1121837499  grid.69566.3a   \n",
       "4     pub.1121837499  grid.69566.3a   \n",
       "...              ...            ...   \n",
       "5915  pub.1131102254  grid.69566.3a   \n",
       "5916  pub.1131102254  grid.69566.3a   \n",
       "5917  pub.1131102254  grid.69566.3a   \n",
       "5918  pub.1131102254  grid.69566.3a   \n",
       "5919  pub.1131102254  grid.69566.3a   \n",
       "\n",
       "                                        raw_affiliation  \n",
       "0     Evidence-based Cardiovascular Medicine, Tohoku...  \n",
       "1     Evidence-based Cardiovascular Medicine, Tohoku...  \n",
       "2     Department of Molecular Endocrinology, Tohoku ...  \n",
       "3     Department of Molecular Endocrinology, Tohoku ...  \n",
       "4     Department of Molecular Endocrinology, Tohoku ...  \n",
       "...                                                 ...  \n",
       "5915  Department of Neurosurgery, Tohoku University ...  \n",
       "5916  Department of Neurosurgery, Tohoku University ...  \n",
       "5917  Department of Neurosurgical Engineering and Tr...  \n",
       "5918  Department of Neurosurgery, Tohoku University ...  \n",
       "5919  Department of Neurosurgery, Tohoku University ...  \n",
       "\n",
       "[5920 rows x 3 columns]"
      ]
     },
     "execution_count": 48,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "\n",
    "SELECT\n",
    "  id, aff.grid_id, aff.raw_affiliation\n",
    "FROM\n",
    "  `dimensions-ai.data_analytics.publications`,\n",
    "  UNNEST(authors) auth,\n",
    "  UNNEST(auth.affiliations_address) AS aff\n",
    "WHERE\n",
    "  year = 2020\n",
    "  AND aff.grid_id = \"grid.69566.3a\"\n",
    "  AND LOWER(aff.raw_affiliation) LIKE \"%school of medicine%\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "variant, to get unique publication records with affiliation count "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 49,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 2/2 [00:00<00:00, 1722.51query/s]                        \n",
      "Downloading: 100%|██████████| 1492/1492 [00:02<00:00, 543.31rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>matching_affiliations</th>\n",
       "      <th>id</th>\n",
       "      <th>title</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>pub.1120113207</td>\n",
       "      <td>Renal damage in primary aldosteronism: a syste...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>47</td>\n",
       "      <td>pub.1124019204</td>\n",
       "      <td>Study profile of The Tohoku Medical Megabank C...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1</td>\n",
       "      <td>pub.1123669309</td>\n",
       "      <td>CD4+ T Cells as Key Players in the Immunopatho...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>5</td>\n",
       "      <td>pub.1123675210</td>\n",
       "      <td>Effects of Long-Term Exercise on Liver Cyst in...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1</td>\n",
       "      <td>pub.1123793958</td>\n",
       "      <td>Degenerative rotator cuff tear, repair or not ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1487</th>\n",
       "      <td>1</td>\n",
       "      <td>pub.1132236309</td>\n",
       "      <td>Protracted rosiglitazone treatment exacerbates...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1488</th>\n",
       "      <td>3</td>\n",
       "      <td>pub.1132927290</td>\n",
       "      <td>Benefits of eculizumab in AQP4+ neuromyelitis ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1489</th>\n",
       "      <td>2</td>\n",
       "      <td>pub.1133258481</td>\n",
       "      <td>RARE-26. RETROSPECTIVE ANALYSIS OF PEDIATRIC C...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1490</th>\n",
       "      <td>12</td>\n",
       "      <td>pub.1133397887</td>\n",
       "      <td>Echolalia in patients with primary progressive...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1491</th>\n",
       "      <td>2</td>\n",
       "      <td>pub.1133346233</td>\n",
       "      <td>BEX2 suppresses mitochondrial activity and is ...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1492 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      matching_affiliations              id  \\\n",
       "0                         1  pub.1120113207   \n",
       "1                        47  pub.1124019204   \n",
       "2                         1  pub.1123669309   \n",
       "3                         5  pub.1123675210   \n",
       "4                         1  pub.1123793958   \n",
       "...                     ...             ...   \n",
       "1487                      1  pub.1132236309   \n",
       "1488                      3  pub.1132927290   \n",
       "1489                      2  pub.1133258481   \n",
       "1490                     12  pub.1133397887   \n",
       "1491                      2  pub.1133346233   \n",
       "\n",
       "                                                  title  \n",
       "0     Renal damage in primary aldosteronism: a syste...  \n",
       "1     Study profile of The Tohoku Medical Megabank C...  \n",
       "2     CD4+ T Cells as Key Players in the Immunopatho...  \n",
       "3     Effects of Long-Term Exercise on Liver Cyst in...  \n",
       "4     Degenerative rotator cuff tear, repair or not ...  \n",
       "...                                                 ...  \n",
       "1487  Protracted rosiglitazone treatment exacerbates...  \n",
       "1488  Benefits of eculizumab in AQP4+ neuromyelitis ...  \n",
       "1489  RARE-26. RETROSPECTIVE ANALYSIS OF PEDIATRIC C...  \n",
       "1490  Echolalia in patients with primary progressive...  \n",
       "1491  BEX2 suppresses mitochondrial activity and is ...  \n",
       "\n",
       "[1492 rows x 3 columns]"
      ]
     },
     "execution_count": 49,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "\n",
    "\n",
    "SELECT\n",
    "  COUNT(aff) AS matching_affiliations,\n",
    "  id,\n",
    "  title.preferred AS title\n",
    "FROM\n",
    "  `dimensions-ai.data_analytics.publications`,\n",
    "  UNNEST(authors) auth,\n",
    "  UNNEST(auth.affiliations_address) AS aff\n",
    "WHERE\n",
    "  year = 2020\n",
    "  AND aff.grid_id = \"grid.69566.3a\"\n",
    "  AND LOWER(aff.raw_affiliation) LIKE \"%school of medicine%\"\n",
    "GROUP BY\n",
    "  id,\n",
    "  title"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Publications with corresponding authors by publisher "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 51,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 4/4 [00:00<00:00, 1715.81query/s]                        \n",
      "Downloading: 100%|██████████| 421/421 [00:03<00:00, 134.06rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "      <th>name</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>8733776</td>\n",
       "      <td>Elsevier</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>5885408</td>\n",
       "      <td>Springer Nature</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>813007</td>\n",
       "      <td>Institute of Electrical and Electronics Engine...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>683093</td>\n",
       "      <td>SAGE Publications</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>380636</td>\n",
       "      <td>MDPI</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>416</th>\n",
       "      <td>1</td>\n",
       "      <td>Society for Sedimentary Geology</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>417</th>\n",
       "      <td>1</td>\n",
       "      <td>Scientific Archives LLC</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>418</th>\n",
       "      <td>1</td>\n",
       "      <td>Museum of Comparative Zoology, Harvard University</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>419</th>\n",
       "      <td>1</td>\n",
       "      <td>Institute of Lifestyle Medicine</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>420</th>\n",
       "      <td>1</td>\n",
       "      <td>Christ University Bangalore</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>421 rows × 2 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "         tot                                               name\n",
       "0    8733776                                           Elsevier\n",
       "1    5885408                                    Springer Nature\n",
       "2     813007  Institute of Electrical and Electronics Engine...\n",
       "3     683093                                  SAGE Publications\n",
       "4     380636                                               MDPI\n",
       "..       ...                                                ...\n",
       "416        1                    Society for Sedimentary Geology\n",
       "417        1                            Scientific Archives LLC\n",
       "418        1  Museum of Comparative Zoology, Harvard University\n",
       "419        1                    Institute of Lifestyle Medicine\n",
       "420        1                        Christ University Bangalore\n",
       "\n",
       "[421 rows x 2 columns]"
      ]
     },
     "execution_count": 51,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select count(distinct id) as tot , publisher.name\n",
    "from `dimensions-ai.data_analytics.publications`, unnest(authors) aff\n",
    "where aff.corresponding is true and publisher.name is not null\n",
    "group by publisher.name\n",
    "order by tot desc"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Funding by journal"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 56,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 5/5 [00:00<00:00, 2062.70query/s]                        \n",
      "Downloading: 100%|██████████| 831/831 [00:03<00:00, 262.38rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>funders</th>\n",
       "      <th>pubs</th>\n",
       "      <th>grants</th>\n",
       "      <th>name</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>grid.48336.3a</td>\n",
       "      <td>2699</td>\n",
       "      <td>2484</td>\n",
       "      <td>National Cancer Institute</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>grid.419681.3</td>\n",
       "      <td>2008</td>\n",
       "      <td>1878</td>\n",
       "      <td>National Institute of Allergy and Infectious D...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>grid.419635.c</td>\n",
       "      <td>1620</td>\n",
       "      <td>1564</td>\n",
       "      <td>National Institute of Diabetes and Digestive a...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>grid.279885.9</td>\n",
       "      <td>1612</td>\n",
       "      <td>1525</td>\n",
       "      <td>National Heart Lung and Blood Institute</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>grid.416870.c</td>\n",
       "      <td>712</td>\n",
       "      <td>668</td>\n",
       "      <td>National Institute of Neurological Disorders a...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>826</th>\n",
       "      <td>grid.453131.1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>Yorkshire Cancer Research</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>827</th>\n",
       "      <td>grid.467619.b</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>W.W Grainger (United States)</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>828</th>\n",
       "      <td>grid.467239.d</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>Zimmer Biomet (United States)</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>829</th>\n",
       "      <td>grid.280878.d</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>New York State Office of Mental Health</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>830</th>\n",
       "      <td>grid.454756.1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>Reumafonds</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>831 rows × 4 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "           funders  pubs  grants  \\\n",
       "0    grid.48336.3a  2699    2484   \n",
       "1    grid.419681.3  2008    1878   \n",
       "2    grid.419635.c  1620    1564   \n",
       "3    grid.279885.9  1612    1525   \n",
       "4    grid.416870.c   712     668   \n",
       "..             ...   ...     ...   \n",
       "826  grid.453131.1     1       0   \n",
       "827  grid.467619.b     1       0   \n",
       "828  grid.467239.d     1       0   \n",
       "829  grid.280878.d     1       0   \n",
       "830  grid.454756.1     1       0   \n",
       "\n",
       "                                                  name  \n",
       "0                            National Cancer Institute  \n",
       "1    National Institute of Allergy and Infectious D...  \n",
       "2    National Institute of Diabetes and Digestive a...  \n",
       "3              National Heart Lung and Blood Institute  \n",
       "4    National Institute of Neurological Disorders a...  \n",
       "..                                                 ...  \n",
       "826                          Yorkshire Cancer Research  \n",
       "827                       W.W Grainger (United States)  \n",
       "828                      Zimmer Biomet (United States)  \n",
       "829             New York State Office of Mental Health  \n",
       "830                                         Reumafonds  \n",
       "\n",
       "[831 rows x 4 columns]"
      ]
     },
     "execution_count": 56,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "with funding as (\n",
    "SELECT funding.grid_id as funders, count(id) as pubs,  count(funding.grant_id) as grants\n",
    "FROM `dimensions-ai.data_analytics.publications`, unnest(funding_details) as funding\n",
    "where journal.id = \"jour.1113716\" -- nature medicine \n",
    "GROUP BY funders)\n",
    "select funding.*, grid.name \n",
    "from funding \n",
    "join `dimensions-ai.data_analytics.grid` grid on funding.funders = grid.id  \n",
    "ORDER BY pubs DESC, grants DESC\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Articles with SDGs"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 64,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 2/2 [00:00<00:00, 795.51query/s]                         \n",
      "Downloading: 100%|██████████| 5/5 [00:02<00:00,  1.96rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>doi</th>\n",
       "      <th>date_inserted</th>\n",
       "      <th>name</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>pub.1013334466</td>\n",
       "      <td>10.1017/s0261340900021950</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "      <td>Peace, Justice and Strong Institutions</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>pub.1025550519</td>\n",
       "      <td>10.1017/s0261340900021780</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "      <td>Peace, Justice and Strong Institutions</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>pub.1106406142</td>\n",
       "      <td>None</td>\n",
       "      <td>2018-09-01 10:48:57+00:00</td>\n",
       "      <td>Good Health and Well Being</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>pub.1104914054</td>\n",
       "      <td>None</td>\n",
       "      <td>2018-06-20 15:35:59+00:00</td>\n",
       "      <td>Good Health and Well Being</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>pub.1038799356</td>\n",
       "      <td>10.1056/nejm184601140332401</td>\n",
       "      <td>2017-08-31 12:50:56+00:00</td>\n",
       "      <td>Good Health and Well Being</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "               id                          doi             date_inserted  \\\n",
       "0  pub.1013334466    10.1017/s0261340900021950 2017-08-31 12:50:56+00:00   \n",
       "1  pub.1025550519    10.1017/s0261340900021780 2017-08-31 12:50:56+00:00   \n",
       "2  pub.1106406142                         None 2018-09-01 10:48:57+00:00   \n",
       "3  pub.1104914054                         None 2018-06-20 15:35:59+00:00   \n",
       "4  pub.1038799356  10.1056/nejm184601140332401 2017-08-31 12:50:56+00:00   \n",
       "\n",
       "                                     name  \n",
       "0  Peace, Justice and Strong Institutions  \n",
       "1  Peace, Justice and Strong Institutions  \n",
       "2              Good Health and Well Being  \n",
       "3              Good Health and Well Being  \n",
       "4              Good Health and Well Being  "
      ]
     },
     "execution_count": 64,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select p.id, p.doi, p.date_inserted, sdg.name \n",
    "from `dimensions-ai.data_analytics.publications` p, unnest(category_sdg.full) sdg\n",
    "where sdg is not null \n",
    "limit 5"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "Count how many pubs per SDG"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 65,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 4/4 [00:00<00:00, 1851.18query/s]                        \n",
      "Downloading: 100%|██████████| 5/5 [00:02<00:00,  1.98rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "      <th>name</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>748342</td>\n",
       "      <td>Peace, Justice and Strong Institutions</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>49065</td>\n",
       "      <td>No Poverty</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>184789</td>\n",
       "      <td>Reduced Inequalities</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>260191</td>\n",
       "      <td>Decent Work and Economic Growth</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>230736</td>\n",
       "      <td>Sustainable Cities and Communities</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "      tot                                    name\n",
       "0  748342  Peace, Justice and Strong Institutions\n",
       "1   49065                              No Poverty\n",
       "2  184789                    Reduced Inequalities\n",
       "3  260191         Decent Work and Economic Growth\n",
       "4  230736      Sustainable Cities and Communities"
      ]
     },
     "execution_count": 65,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select COUNT(DISTINCT p.id) as tot, sdg.name \n",
    "from `dimensions-ai.data_analytics.publications` p, unnest(category_sdg.full) sdg\n",
    "GROUP BY sdg.name\n",
    "limit 5"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Journals with LIKE string matching"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 71,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 3/3 [00:00<00:00, 1209.20query/s]                        \n",
      "Downloading: 100%|██████████| 20/20 [00:02<00:00,  7.83rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>pubs</th>\n",
       "      <th>id</th>\n",
       "      <th>title</th>\n",
       "      <th>issn</th>\n",
       "      <th>eissn</th>\n",
       "      <th>name</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>168620</td>\n",
       "      <td>jour.1014075</td>\n",
       "      <td>New England Journal of Medicine</td>\n",
       "      <td>0028-4793</td>\n",
       "      <td>1533-4406</td>\n",
       "      <td>Massachusetts Medical Society</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>83860</td>\n",
       "      <td>jour.1011551</td>\n",
       "      <td>Medicine &amp; Science in Sports &amp; Exercise</td>\n",
       "      <td>0195-9131</td>\n",
       "      <td>1530-0315</td>\n",
       "      <td>Wolters Kluwer</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>58617</td>\n",
       "      <td>jour.1017222</td>\n",
       "      <td>Annals of Internal Medicine</td>\n",
       "      <td>0003-4819</td>\n",
       "      <td>1539-3704</td>\n",
       "      <td>American College of Physicians</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>52792</td>\n",
       "      <td>jour.1312267</td>\n",
       "      <td>Journal of the Royal Society of Medicine</td>\n",
       "      <td>0141-0768</td>\n",
       "      <td>1758-1095</td>\n",
       "      <td>SAGE Publications</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>52248</td>\n",
       "      <td>jour.1017256</td>\n",
       "      <td>JAMA Internal Medicine</td>\n",
       "      <td>2168-6106</td>\n",
       "      <td>2168-6114</td>\n",
       "      <td>American Medical Association (AMA)</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>47104</td>\n",
       "      <td>jour.1027092</td>\n",
       "      <td>Experimental Biology and Medicine</td>\n",
       "      <td>1535-3702</td>\n",
       "      <td>1535-3699</td>\n",
       "      <td>SAGE Publications</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>46274</td>\n",
       "      <td>jour.1016342</td>\n",
       "      <td>Critical Care Medicine</td>\n",
       "      <td>0090-3493</td>\n",
       "      <td>1530-0293</td>\n",
       "      <td>Wolters Kluwer</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>37632</td>\n",
       "      <td>jour.1057918</td>\n",
       "      <td>Journal of Molecular Medicine</td>\n",
       "      <td>0946-2716</td>\n",
       "      <td>1432-1440</td>\n",
       "      <td>Springer Nature</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>34891</td>\n",
       "      <td>jour.1017275</td>\n",
       "      <td>Arizona Medicine</td>\n",
       "      <td>0093-0415</td>\n",
       "      <td>1476-2978</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>31068</td>\n",
       "      <td>jour.1014535</td>\n",
       "      <td>The American Journal of Medicine</td>\n",
       "      <td>0002-9343</td>\n",
       "      <td>1555-7162</td>\n",
       "      <td>Elsevier</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>29708</td>\n",
       "      <td>jour.1017863</td>\n",
       "      <td>Oral Surgery Oral Medicine Oral Pathology and ...</td>\n",
       "      <td>2212-4403</td>\n",
       "      <td>2212-4411</td>\n",
       "      <td>Elsevier</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>28472</td>\n",
       "      <td>jour.1090935</td>\n",
       "      <td>Annals of Emergency Medicine</td>\n",
       "      <td>0196-0644</td>\n",
       "      <td>1097-6760</td>\n",
       "      <td>Elsevier</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>26224</td>\n",
       "      <td>jour.1077253</td>\n",
       "      <td>Medicine</td>\n",
       "      <td>0025-7974</td>\n",
       "      <td>1536-5964</td>\n",
       "      <td>Wolters Kluwer</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>25653</td>\n",
       "      <td>jour.1017316</td>\n",
       "      <td>Bulletin of Experimental Biology and Medicine</td>\n",
       "      <td>0007-4888</td>\n",
       "      <td>1573-8221</td>\n",
       "      <td>Springer Nature</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>24781</td>\n",
       "      <td>jour.1077126</td>\n",
       "      <td>Journal of Experimental Medicine</td>\n",
       "      <td>0022-1007</td>\n",
       "      <td>1540-9538</td>\n",
       "      <td>Rockefeller University Press</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>24339</td>\n",
       "      <td>jour.1319882</td>\n",
       "      <td>Journal of Internal Medicine</td>\n",
       "      <td>0954-6820</td>\n",
       "      <td>1365-2796</td>\n",
       "      <td>Wiley</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>23511</td>\n",
       "      <td>jour.1017748</td>\n",
       "      <td>Academic Medicine</td>\n",
       "      <td>1040-2446</td>\n",
       "      <td>1938-808X</td>\n",
       "      <td>Wolters Kluwer</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>22601</td>\n",
       "      <td>jour.1017031</td>\n",
       "      <td>American Journal of Respiratory and Critical C...</td>\n",
       "      <td>1073-449X</td>\n",
       "      <td>1535-4970</td>\n",
       "      <td>American Thoracic Society</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>22220</td>\n",
       "      <td>jour.1036793</td>\n",
       "      <td>Military Medicine</td>\n",
       "      <td>0026-4075</td>\n",
       "      <td>1930-613X</td>\n",
       "      <td>Oxford University Press (OUP)</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>21695</td>\n",
       "      <td>jour.1017021</td>\n",
       "      <td>American Journal of Tropical Medicine and Hygiene</td>\n",
       "      <td>0002-9637</td>\n",
       "      <td>1476-1645</td>\n",
       "      <td>American Society of Tropical Medicine and Hygiene</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "      pubs            id                                              title  \\\n",
       "0   168620  jour.1014075                    New England Journal of Medicine   \n",
       "1    83860  jour.1011551            Medicine & Science in Sports & Exercise   \n",
       "2    58617  jour.1017222                        Annals of Internal Medicine   \n",
       "3    52792  jour.1312267           Journal of the Royal Society of Medicine   \n",
       "4    52248  jour.1017256                             JAMA Internal Medicine   \n",
       "5    47104  jour.1027092                  Experimental Biology and Medicine   \n",
       "6    46274  jour.1016342                             Critical Care Medicine   \n",
       "7    37632  jour.1057918                      Journal of Molecular Medicine   \n",
       "8    34891  jour.1017275                                   Arizona Medicine   \n",
       "9    31068  jour.1014535                   The American Journal of Medicine   \n",
       "10   29708  jour.1017863  Oral Surgery Oral Medicine Oral Pathology and ...   \n",
       "11   28472  jour.1090935                       Annals of Emergency Medicine   \n",
       "12   26224  jour.1077253                                           Medicine   \n",
       "13   25653  jour.1017316      Bulletin of Experimental Biology and Medicine   \n",
       "14   24781  jour.1077126                   Journal of Experimental Medicine   \n",
       "15   24339  jour.1319882                       Journal of Internal Medicine   \n",
       "16   23511  jour.1017748                                  Academic Medicine   \n",
       "17   22601  jour.1017031  American Journal of Respiratory and Critical C...   \n",
       "18   22220  jour.1036793                                  Military Medicine   \n",
       "19   21695  jour.1017021  American Journal of Tropical Medicine and Hygiene   \n",
       "\n",
       "         issn      eissn                                               name  \n",
       "0   0028-4793  1533-4406                      Massachusetts Medical Society  \n",
       "1   0195-9131  1530-0315                                     Wolters Kluwer  \n",
       "2   0003-4819  1539-3704                     American College of Physicians  \n",
       "3   0141-0768  1758-1095                                  SAGE Publications  \n",
       "4   2168-6106  2168-6114                 American Medical Association (AMA)  \n",
       "5   1535-3702  1535-3699                                  SAGE Publications  \n",
       "6   0090-3493  1530-0293                                     Wolters Kluwer  \n",
       "7   0946-2716  1432-1440                                    Springer Nature  \n",
       "8   0093-0415  1476-2978                                               None  \n",
       "9   0002-9343  1555-7162                                           Elsevier  \n",
       "10  2212-4403  2212-4411                                           Elsevier  \n",
       "11  0196-0644  1097-6760                                           Elsevier  \n",
       "12  0025-7974  1536-5964                                     Wolters Kluwer  \n",
       "13  0007-4888  1573-8221                                    Springer Nature  \n",
       "14  0022-1007  1540-9538                       Rockefeller University Press  \n",
       "15  0954-6820  1365-2796                                              Wiley  \n",
       "16  1040-2446  1938-808X                                     Wolters Kluwer  \n",
       "17  1073-449X  1535-4970                          American Thoracic Society  \n",
       "18  0026-4075  1930-613X                      Oxford University Press (OUP)  \n",
       "19  0002-9637  1476-1645  American Society of Tropical Medicine and Hygiene  "
      ]
     },
     "execution_count": 71,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select COUNT(*) as pubs, journal.id, journal.title, journal.issn, journal.eissn, publisher.name\n",
    "from `dimensions-ai.data_analytics.publications` \n",
    "where  LOWER( journal.title ) LIKE  CONCAT('%medicine%')\n",
    "group by 2, 3, 4, 5, 6\n",
    "order by pubs desc\n",
    "limit 20"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## New vs recurring authors, for a specific journal"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 73,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 10/10 [00:00<00:00, 5324.75query/s]                       \n",
      "Downloading: 100%|██████████| 10/10 [00:02<00:00,  4.04rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>year</th>\n",
       "      <th>num_first</th>\n",
       "      <th>num_recurring</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2011</td>\n",
       "      <td>1040</td>\n",
       "      <td>352</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2012</td>\n",
       "      <td>858</td>\n",
       "      <td>373</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2013</td>\n",
       "      <td>926</td>\n",
       "      <td>345</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2014</td>\n",
       "      <td>1088</td>\n",
       "      <td>338</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2015</td>\n",
       "      <td>1044</td>\n",
       "      <td>392</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>2016</td>\n",
       "      <td>1313</td>\n",
       "      <td>350</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>2017</td>\n",
       "      <td>1072</td>\n",
       "      <td>404</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>2018</td>\n",
       "      <td>1104</td>\n",
       "      <td>419</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>2019</td>\n",
       "      <td>1184</td>\n",
       "      <td>442</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>2020</td>\n",
       "      <td>1579</td>\n",
       "      <td>568</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   year  num_first  num_recurring\n",
       "0  2011       1040            352\n",
       "1  2012        858            373\n",
       "2  2013        926            345\n",
       "3  2014       1088            338\n",
       "4  2015       1044            392\n",
       "5  2016       1313            350\n",
       "6  2017       1072            404\n",
       "7  2018       1104            419\n",
       "8  2019       1184            442\n",
       "9  2020       1579            568"
      ]
     },
     "execution_count": 73,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "\n",
    "WITH authoryear AS (\n",
    "  select pubs.year, author.researcher_id, COUNT(pubs.id) AS numpubs\n",
    "  FROM `dimensions-ai.data_analytics.publications` as pubs\n",
    "  CROSS JOIN UNNEST(pubs.authors) AS author\n",
    "  WHERE author.researcher_id IS NOT NULL AND journal.id= \"jour.1115214\"\n",
    "  GROUP BY author.researcher_id, pubs.year\n",
    "), authorfirst AS (\n",
    "  select researcher_id, MIN(year) AS minyear\n",
    "  FROM authoryear\n",
    "  GROUP BY researcher_id\n",
    "), authorsummary AS (\n",
    "  SELECT ay.*, IF(ay.year=af.minyear, TRUE, FALSE) AS firstyear\n",
    "  FROM authoryear ay\n",
    "  JOIN authorfirst af ON af.researcher_id=ay.researcher_id\n",
    "  ORDER BY ay.researcher_id, year\n",
    "), numauthors AS (\n",
    "  SELECT year, firstyear, COUNT(DISTINCT researcher_id) AS numresearchers\n",
    "  FROM authorsummary\n",
    "  WHERE year>2010\n",
    "  GROUP BY year, firstyear\n",
    ")\n",
    "SELECT year, SUM(CASE when firstyear then numresearchers else 0 end) as num_first,\n",
    "             SUM(CASE when NOT firstyear then numresearchers else 0 end) as num_recurring\n",
    "from numauthors\n",
    "group by year\n",
    "order by year;\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## incoming citations for a journal"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 77,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 7/7 [00:00<00:00, 3743.00query/s]                        \n",
      "Downloading: 100%|██████████| 201/201 [00:02<00:00, 79.73rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>totcount</th>\n",
       "      <th>year</th>\n",
       "      <th>type</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>9</td>\n",
       "      <td>NaN</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>1924.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1</td>\n",
       "      <td>1942.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1</td>\n",
       "      <td>1963.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1</td>\n",
       "      <td>1964.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>196</th>\n",
       "      <td>1</td>\n",
       "      <td>2021.0</td>\n",
       "      <td>book</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>197</th>\n",
       "      <td>612</td>\n",
       "      <td>2021.0</td>\n",
       "      <td>chapter</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>198</th>\n",
       "      <td>26</td>\n",
       "      <td>2021.0</td>\n",
       "      <td>monograph</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>199</th>\n",
       "      <td>894</td>\n",
       "      <td>2021.0</td>\n",
       "      <td>preprint</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>200</th>\n",
       "      <td>3</td>\n",
       "      <td>2021.0</td>\n",
       "      <td>proceeding</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>201 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     totcount    year        type\n",
       "0           9     NaN     article\n",
       "1           1  1924.0     article\n",
       "2           1  1942.0     article\n",
       "3           1  1963.0     article\n",
       "4           1  1964.0     article\n",
       "..        ...     ...         ...\n",
       "196         1  2021.0        book\n",
       "197       612  2021.0     chapter\n",
       "198        26  2021.0   monograph\n",
       "199       894  2021.0    preprint\n",
       "200         3  2021.0  proceeding\n",
       "\n",
       "[201 rows x 3 columns]"
      ]
     },
     "execution_count": 77,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select COUNT(distinct id) as totcount, year, type\n",
    "from `dimensions-ai.data_analytics.publications` \n",
    "where id in \n",
    "  ( select citing_pubs.id\n",
    "    from `dimensions-ai.data_analytics.publications`, UNNEST(citations) as citing_pubs\n",
    "    where  journal.id = \"jour.1115214\" \n",
    "  )\n",
    "group by year, type\n",
    "order by year, type  "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Outgoing citations to a journal"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 80,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 8/8 [00:00<00:00, 2721.81query/s]                        \n",
      "Downloading: 100%|██████████| 356/356 [00:02<00:00, 139.64rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>totcount</th>\n",
       "      <th>year</th>\n",
       "      <th>type</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>1825.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1</td>\n",
       "      <td>1828.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1</td>\n",
       "      <td>1853.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1</td>\n",
       "      <td>1855.0</td>\n",
       "      <td>monograph</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>351</th>\n",
       "      <td>3</td>\n",
       "      <td>2019.0</td>\n",
       "      <td>proceeding</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>352</th>\n",
       "      <td>409</td>\n",
       "      <td>2020.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>353</th>\n",
       "      <td>5</td>\n",
       "      <td>2020.0</td>\n",
       "      <td>chapter</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>354</th>\n",
       "      <td>34</td>\n",
       "      <td>2020.0</td>\n",
       "      <td>preprint</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>355</th>\n",
       "      <td>1</td>\n",
       "      <td>2021.0</td>\n",
       "      <td>article</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>356 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     totcount    year        type\n",
       "0           1     NaN     article\n",
       "1           1  1825.0     article\n",
       "2           1  1828.0     article\n",
       "3           1  1853.0     article\n",
       "4           1  1855.0   monograph\n",
       "..        ...     ...         ...\n",
       "351         3  2019.0  proceeding\n",
       "352       409  2020.0     article\n",
       "353         5  2020.0     chapter\n",
       "354        34  2020.0    preprint\n",
       "355         1  2021.0     article\n",
       "\n",
       "[356 rows x 3 columns]"
      ]
     },
     "execution_count": 80,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "select COUNT(distinct id) as totcount, year, type\n",
    "from `dimensions-ai.data_analytics.publications` \n",
    "where id in \n",
    "  ( select distinct reference_pubs\n",
    "    from `dimensions-ai.data_analytics.publications`, UNNEST(reference_ids) as reference_pubs\n",
    "    where  journal.id = \"jour.1115214\" \n",
    "  )\n",
    "group by year, type\n",
    "order by year, type  "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Concepts: select publications matching selected concepts"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 86,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Query complete after 0.00s: 100%|██████████| 3/3 [00:00<00:00, 2063.11query/s]                        \n",
      "Downloading: 100%|██████████| 10/10 [00:02<00:00,  4.21rows/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>publisher</th>\n",
       "      <th>year</th>\n",
       "      <th>num_pub</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2020</td>\n",
       "      <td>31812</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2018</td>\n",
       "      <td>29580</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2019</td>\n",
       "      <td>28941</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2017</td>\n",
       "      <td>28415</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2015</td>\n",
       "      <td>27301</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2011</td>\n",
       "      <td>25758</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2016</td>\n",
       "      <td>25149</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2013</td>\n",
       "      <td>23209</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>Elsevier</td>\n",
       "      <td>2014</td>\n",
       "      <td>23100</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>Springer Nature</td>\n",
       "      <td>2019</td>\n",
       "      <td>22072</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "         publisher  year  num_pub\n",
       "0         Elsevier  2020    31812\n",
       "1         Elsevier  2018    29580\n",
       "2         Elsevier  2019    28941\n",
       "3         Elsevier  2017    28415\n",
       "4         Elsevier  2015    27301\n",
       "5         Elsevier  2011    25758\n",
       "6         Elsevier  2016    25149\n",
       "7         Elsevier  2013    23209\n",
       "8         Elsevier  2014    23100\n",
       "9  Springer Nature  2019    22072"
      ]
     },
     "execution_count": 86,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --project $MY_PROJECT_ID\n",
    "\n",
    "WITH tropical_diseases AS (\n",
    "    select * from `dimensions-ai.data_analytics.publications`\n",
    ")\n",
    "SELECT publisher.name as publisher, year, count(*) as num_pub\n",
    "FROM tropical_diseases, UNNEST(tropical_diseases.concepts) c\n",
    "WHERE \n",
    "  (lower(c.concept) in UNNEST([\"buruli ulcer\", \"mycobacterium\", \"mycolactone\", \"bairnsdale ulcer\"]) \n",
    "  OR REGEXP_CONTAINS(title.preferred, r\"(?i)/buruli ulcer|mycobacterium|mycolactone|bairnsdale ulcer/\"))\n",
    "  AND year >= 2010\n",
    "  AND publisher IS NOT NULL\n",
    "GROUP BY publisher,year\n",
    "ORDER BY num_pub DESC, year, publisher\n",
    "limit 10"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
