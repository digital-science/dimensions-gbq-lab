# 32. Creating a concepts network

!!! warning "Level: Advanced"
    This query requires a good understanding of SQL and the Dimensions data model


## Description

This query generates two-concept pairs and counts how many publications are shared between these concepts (note: concepts in Dimensions are publication-level keywords normalised and weighted based on a relevancy score).

The query includes a user input query (`user-provided-subquery`) that can customised so to focus on arbitrary subsets of the Dimensions database. Also, parameters values for max number of nodes and min weight of edges to be included in the result (@max_nodes, @min_edge_weight) can be fine-tuned as needed. 

The gist of the query lies in the double CROSS JOIN UNNEST. This mechanism allows to traverse a potentially very large number of relationships in seconds and to expose all relevant combinations of co-authoring organisations within the same data structure.

For more details, see also: 

* [Generating large-scale network analyses of scientific landscapes in seconds using Dimensions on Google BigQuery](https://zenodo.org/records/6951456#.YySlhOxuerM), International Conference on Science, Technology and Innovation Indicators (STI 2022) Granada September 2022
* Python tool to generate network visualizations: [website](https://digital-science.github.io/dimensions-network-gen/) and source code in [Github](https://github.com/digital-science/dimensions-network-gen) 

## Query

For example, we can generate a concepts cooccurence network for all publications from the last 30 days that have an Altmetric Attention Score greater than 10:

```sql
WITH subset AS (

          -- USER-PROVIDED-SUBQUERY
          -- add any query in this section, as long as it returns publication IDs
          -- EG here we get all papers from the last 30 days with Altmetric attention > 10

          SELECT
              id
          FROM
              `dimensions-ai.data_analytics.publications`
          WHERE
              EXTRACT(
                  DATE
                  FROM
                      date_inserted
              ) >= DATE_ADD(CURRENT_DATE(), INTERVAL -30 DAY)
              AND altmetrics.score > 10

        ),
        papercount AS (
            SELECT concept.concept, COUNT(p.id) AS papers,
            FROM `dimensions-ai.data_analytics.publications` p
            INNER JOIN subset ON p.id=subset.id
            CROSS JOIN UNNEST(p.concepts) concept
            WHERE
                year >= 1965
                AND concept.relevance >= 0.5 -- @min_link_relevance
            GROUP BY 1
        ),
        filtered AS (
            SELECT *
            FROM papercount
            WHERE papers >= 5 --@min_concept_frequency
            ORDER BY papers DESC
            LIMIT 500 -- @max_nodes
        ),
        results AS (
        SELECT concept1.concept AS concept_a, concept2.concept AS concept_b,
            COUNT(p.id) AS overlap,
        FROM `dimensions-ai.data_analytics.publications` p
        INNER JOIN subset ON p.id=subset.id
        CROSS JOIN UNNEST(p.concepts) concept1
        CROSS JOIN UNNEST(p.concepts) concept2
        INNER JOIN filtered pcount1 ON concept1.concept=pcount1.concept
        INNER JOIN filtered pcount2 ON concept2.concept=pcount2.concept
        WHERE year >= 1965
            AND concept1.relevance >= 0.5 --@min_link_relevance
            AND concept2.relevance >= 0.5 --@min_link_relevance
            AND concept1.concept <> concept2.concept
        GROUP BY 1,2
        )
        SELECT *
        FROM results
        WHERE overlap >= 3 --@min_edge_weight
```


A visualization using the results of this query can be [explored online](https://digital-science.github.io/dimensions-network-gen/wrapper.html?topicId=last_30_days&network=concepts) (note: the visualization uses data from the [COVID-19 dataset](https://console.cloud.google.com/marketplace/product/digitalscience-public/covid-19-dataset-dimensions))